{% extends 'base.html' %}

{% block content %}
<div class="container my-4">
  <h1 class="text-center mb-5">Beans List</h1>
  <div class="row" id="bean-cards-container">
    {% for bean in beans %}
    {% include 'components/bean_card.html' %}
    {% endfor %}
  </div>
</div>

{% include 'components/bean_modal.html' %}


<script id="beans-data" type="application/json">
  {{ beans | tojson }}
</script>

<script>
  var addBeanModal = new bootstrap.Modal(document.getElementById('addBeanModal'));

  document.addEventListener('DOMContentLoaded', function () {
    const urlParams = new URLSearchParams(window.location.search);
    const beanId = urlParams.get('bean_id');
    const openModal = urlParams.get('open_modal');

    if (beanId) {
      document.getElementById('beanId').value = beanId;
      document.getElementById('addBeanModalLabel').textContent = 'Edit Bean';
    } else {
      document.getElementById('addBeanModalLabel').textContent = 'Add Bean';
    }

    if (openModal === 'true') {
      addBeanModal.show();
    }
  });

  function updateBeanCard(beanId) {
    fetch(`/bean_card/${beanId}`)
      .then(response => {
        if (response.ok) {
          return response.text();
        } else {
          throw new Error('Failed to load updated bean card.');
        }
      })
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newBeanCard = doc.body.firstElementChild;

        const oldBeanCard = document.getElementById(`bean-${beanId}`);
        if (oldBeanCard && newBeanCard) {
          oldBeanCard.replaceWith(newBeanCard);
        }
      });
  }

  function editBean(beanId) {
    const beans = JSON.parse(document.getElementById('beans-data').textContent);
    const selectedBean = beans.find(b => b.id === beanId);

    if (selectedBean) {
      document.getElementById('beanId').value = selectedBean.id;
      document.getElementById('name').value = selectedBean.name;
      document.getElementById('origin').value = selectedBean.origin;
      document.getElementById('region').value = selectedBean.region;
      document.getElementById('varietal').value = selectedBean.varietal;
      document.getElementById('processing_method').value = selectedBean.processing_method;
      document.getElementById('altitude').value = selectedBean.altitude;
      document.getElementById('taste_notes').value = selectedBean.taste_notes;
      document.getElementById('aroma').value = selectedBean.aroma;
      document.getElementById('acidity').value = selectedBean.acidity;
      document.getElementById('brew_methods').value = selectedBean.brew_methods;
      document.getElementById('cupping_score').value = selectedBean.cupping_score;
      document.getElementById('certifications').value = selectedBean.certifications;

      document.getElementById('addBeanModalLabel').textContent = 'Edit Bean';
      addBeanModal.show();
    }
  }

  function deleteBean(beanId) {
    if (confirm('Are you sure you want to delete this bean?')) {
      fetch(`/delete_bean/${beanId}`, {
        method: 'DELETE'
      }).then(response => {
        if (response.ok) {
          // remove bean card from dom if possible; else reload the page
          const beanCard = document.getElementById(`bean-${beanId}`);
          if (beanCard) {
            beanCard.remove();
          } else {
            location.reload();
          }
        } else {
          alert('Failed to delete bean.');
        }
      });
    }
  }

  document.getElementById('beanForm').addEventListener('submit', function (event) {
    event.preventDefault();
    const formData = new FormData(this);
    const beanId = document.getElementById('beanId').value;
    const url = beanId ? `/edit_bean/${beanId}` : '/add_bean';
    const method = beanId ? 'PUT' : 'POST';

    fetch(url, {
      method: method,
      body: formData
    }).then(response => response.json()).then(data => {
      if (data.message === 'Bean added successfully' || data.message === 'Bean updated successfully') {
        addBeanModal.hide();
        alert(data.message);
        updateBeanCard(beanId);
      } else {
        alert('Failed to save bean.');
      }
    });
  });


</script>
{% endblock %}